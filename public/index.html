<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>주식 투자 보조 프로그램</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="style-recommendations.css">
</head>

<body>
  <header>
    <h1>주식 투자 보조 프로그램</h1>
  </header>
  <main>
    <!-- 1. TradingView 차트 -->
    <section id="tradingview-chart">
      <h2>1. TradingView 차트</h2>
      <p class="section-description">종목을 선택하면 자동으로 AI 분석이 시작됩니다</p>
      <!-- TradingView Widget BEGIN -->
      <div class="tradingview-widget-container" style="height:100%;width:100%">
        <div id="tradingview_b4321" style="height:calc(100% - 32px);width:100%"></div>
        <div class="tradingview-widget-copyright"><a href="https://www.tradingview.com/" rel="noopener nofollow"
            target="_blank"><span class="blue-text">Track all markets on TradingView</span></a></div>
        <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
        <script type="text/javascript">
          // TradingView 위젯 초기화
          window.initTradingView = function () {
            if (window.myTradingViewWidget) return;

            if (typeof TradingView !== 'undefined') {
              try {
                window.myTradingViewWidget = new TradingView.widget({
                  "width": "100%",
                  "height": 480,
                  "symbol": "NASDAQ:SPY",
                  "interval": "D",
                  "timezone": "Etc/UTC",
                  "theme": "dark",
                  "style": "1",
                  "locale": "kr",
                  "toolbar_bg": "#131722",
                  "enable_publishing": false,
                  "allow_symbol_change": true,
                  "container_id": "tradingview_b4321",
                  "onready": function () {
                    window.tradingViewWidgetReady = true;
                    window.dispatchEvent(new CustomEvent('tradingViewReady'));
                  }
                });
              } catch (error) {
                // 조용히 에러 처리
              }
            }
          };

          // 라이브러리 로드 체크
          if (typeof TradingView !== 'undefined') {
            window.initTradingView();
          } else {
            let attempts = 0;
            const maxAttempts = 100;
            const checkLibrary = setInterval(() => {
              attempts++;
              if (typeof TradingView !== 'undefined') {
                clearInterval(checkLibrary);
                window.initTradingView();
              } else if (attempts >= maxAttempts) {
                clearInterval(checkLibrary);
              }
            }, 100);
          }

          // 심볼 추적 시스템 (원래 작동하던 코드)
          function extractTickerFromSymbol(symbolName) {
            if (!symbolName) return null;
            const parts = symbolName.split(':');
            return parts.length > 1 ? parts[1] : parts[0];
          }

          window.TradingViewSymbolTracker = {
            currentSymbol: 'NASDAQ:SPY',
            lastCheckedSymbol: '',
            isChecking: false,

            onSymbolChange: function (newSymbol) {
              this.currentSymbol = newSymbol;
              const ticker = extractTickerFromSymbol(newSymbol);
              if (ticker) {
                if (window.StockDetailAnalyzer) {
                  setTimeout(() => {
                    StockDetailAnalyzer.analyzeStock(ticker);
                  }, 1000);
                }
              }
            },

            setSymbol: function (symbol) {
              if (symbol && symbol !== this.currentSymbol) {
                this.onSymbolChange(symbol);
              }
            },

            startChecking: function () {
              if (this.isChecking) return;
              this.isChecking = true;

              // postMessage 리스너 설정
              this.setupPostMessageListener();

              // 주기적 체크
              setInterval(() => {
                this.checkForSymbolChange();
              }, 2000);
            },

            // postMessage 리스너 설정
            setupPostMessageListener: function () {
              window.addEventListener('message', (event) => {
                if (event.origin === 'https://s.tradingview.com') {
                  try {
                    let messageData = event.data;
                    if (typeof messageData === 'string') {
                      messageData = JSON.parse(messageData);
                    }

                    if (messageData.name === 'quoteUpdate' && messageData.data) {
                      const data = messageData.data;
                      let symbol = null;

                      if (data.original_name) {
                        symbol = data.original_name.split(':').pop();
                      } else if (data.short_name) {
                        symbol = data.short_name;
                      } else if (data.symbol) {
                        symbol = data.symbol;
                      }

                      if (symbol && typeof symbol === 'string' && /^[A-Z]{1,10}$/.test(symbol)) {
                        const fullSymbol = `NASDAQ:${symbol}`;
                        if (fullSymbol !== this.currentSymbol) {
                          this.setSymbol(fullSymbol);
                        }
                      }
                    }
                  } catch (e) {
                    // 조용히 무시
                  }
                }
              });
            },

            // URL 기반 심볼 체크
            checkForSymbolChange: function () {
              try {
                if (window.myTradingViewWidget && window.myTradingViewWidget.iframe) {
                  const iframe = window.myTradingViewWidget.iframe;
                  if (iframe.src) {
                    const urlMatch = iframe.src.match(/symbol[=:]([^&]+)/);
                    if (urlMatch && urlMatch[1]) {
                      const symbolFromUrl = decodeURIComponent(urlMatch[1]);
                      if (symbolFromUrl !== this.lastCheckedSymbol) {
                        this.lastCheckedSymbol = symbolFromUrl;
                        if (symbolFromUrl !== this.currentSymbol) {
                          this.setSymbol(symbolFromUrl);
                        }
                      }
                    }
                  }
                }
              } catch (error) {
                // 조용히 무시
              }
            }
          };

          // 자동 시작
          setTimeout(() => {
            window.TradingViewSymbolTracker.startChecking();
          }, 3000);
        </script>
      </div>
      <!-- TradingView Widget END -->
    </section>

    <!-- 2. 선택한 종목 상세 분석 -->
    <section id="selected-stock-analysis">
      <div id="selected-stock-header">
        <h2>2. 선택한 종목 상세 분석</h2>
      </div>
      <div id="selected-stock-fundamentals">
        <div class="fundamental-placeholder">차트에서 종목을 선택하면 기본 정보가 표시됩니다</div>
      </div>
      <div id="selected-stock-details">
        <div class="details-placeholder">차트에서 종목을 선택하면 상세 분석이 표시됩니다</div>
      </div>
      <div id="selected-stock-description">
        <div class="description-placeholder">회사 정보가 여기에 표시됩니다</div>
      </div>
    </section>

    <!-- 3. AI 종목 -->
    <section id="ai-stocks">
      <h2>3. AI 종목</h2>
      <p class="section-description">인공지능 산업 주요 기업들의 실시간 데이터와 간단 분석</p>
      <div class="stock-list-grid">
        <!-- AI stocks will be loaded here -->
      </div>
    </section>

    <!-- 4. 반도체 섹터 종목 -->
    <section id="semiconductor-stocks">
      <h2>4. 반도체 섹터 종목</h2>
      <p class="section-description">반도체 산업 주요 기업들의 실시간 데이터와 간단 분석</p>
      <div class="stock-list-grid">
        <!-- Semiconductor stocks will be loaded here -->
      </div>
    </section>

    <!-- 5. AI 종목 추천 -->
    <section id="monthly-recommendations">
      <div class="recommendation-header">
        <h2>5. 이번달 AI 종목 추천</h2>
        <p class="section-description">최신 뉴스와 시장 데이터를 반영한 AI 기반 월별 종목 추천</p>

        <div class="recommendation-controls">
          <button id="refresh-recommendations" class="btn-refresh">새로고침</button>
          <select id="sector-filter">
            <option value="all">전체</option>
            <option value="ai">AI</option>
            <option value="semiconductor">반도체</option>
          </select>
        </div>
      </div>
      <div id="recommendations-content">
        <div class="loading-spinner">
          <p>최신 뉴스를 분석하여 월별 추천 종목을 생성 중입니다...</p>
        </div>
      </div>
    </section>
  </main>
    <!-- Load scripts in dependency order -->
    <script src="js/logger.js"></script>
    <script src="js/config.js"></script>
    <script src="js/notification-manager.js"></script>
    <script src="js/tooltip-manager.js"></script>
    <script src="js/chart-manager.js"></script>
    <script src="js/analysis-cache-manager.js"></script>
    <script src="js/stock-detail-analyzer.js"></script>
    <script src="js/stock-analyzer.js"></script>
    <script src="js/stock-selector.js"></script>
    <script src="js/seasonal-analysis.js"></script>
    <script src="js/recommendation-ui.js"></script>
    <script src="js/monthly-recommendation-manager.js"></script>
    <script src="client.js"></script>
</body>

</html>
