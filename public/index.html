<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì£¼ì‹ íˆ¬ì ë³´ì¡° í”„ë¡œê·¸ë¨</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="style-recommendations.css">
</head>

<body>
  <header>
    <h1>ì£¼ì‹ íˆ¬ì ë³´ì¡° í”„ë¡œê·¸ë¨</h1>
  </header>
  <main>
    <!-- 1. TradingView ì°¨íŠ¸ -->
    <section id="tradingview-chart">
      <h2>1. TradingView ì°¨íŠ¸</h2>
      <p class="section-description">ì¢…ëª©ì„ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ AI ë¶„ì„ì´ ì‹œì‘ë©ë‹ˆë‹¤</p>
      <!-- TradingView Widget BEGIN -->
      <div class="tradingview-widget-container" style="height:100%;width:100%">
        <div id="tradingview_b4321" style="height:calc(100% - 32px);width:100%"></div>
        <div class="tradingview-widget-copyright"><a href="https://www.tradingview.com/" rel="noopener nofollow"
            target="_blank"><span class="blue-text">Track all markets on TradingView</span></a></div>
        <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
        <script type="text/javascript">
          // TradingView ìœ„ì ¯ ì´ˆê¸°í™” í•¨ìˆ˜ (ê¸€ë¡œë²Œ ìŠ¤ì½”í”„ì— ì„ ì–¸)
          window.initTradingView = function () {
            console.log('initTradingView called');

            // ì¤‘ë³µ ìƒì„± ë°©ì§€
            if (window.myTradingViewWidget) {
              console.log('TradingView widget already exists, skipping...');
              return;
            }

            if (typeof TradingView !== 'undefined') {
              try {
                console.log('Creating TradingView widget...');
                window.myTradingViewWidget = new TradingView.widget({
                  "width": "100%",
                  "height": 480,
                  "symbol": "NASDAQ:SPY",
                  "interval": "D",
                  "timezone": "Etc/UTC",
                  "theme": "light",
                  "style": "1",
                  "locale": "kr",
                  "toolbar_bg": "#f1f3f6",
                  "enable_publishing": false,
                  "allow_symbol_change": true,
                  "container_id": "tradingview_b4321",
                  "onready": function () {
                    console.log('TradingView widget onready callback triggered!');
                    window.tradingViewWidgetReady = true;
                    console.log('Widget object:', window.myTradingViewWidget);
                    console.log('Widget methods:', Object.getOwnPropertyNames(window.myTradingViewWidget));

                    // ìœ„ì ¯ì´ ì¤€ë¹„ë˜ì—ˆë‹¤ëŠ” ì‚¬ìš©ì ì •ì˜ ì´ë²¤íŠ¸ ë°œìƒ
                    window.dispatchEvent(new CustomEvent('tradingViewReady'));
                    console.log('tradingViewReady event dispatched');
                  }
                });
                console.log('TradingView widget created successfully:', window.myTradingViewWidget);

                // ìƒˆë¡œìš´ ì‹¬ë³¼ ì¶”ì  ì‹œìŠ¤í…œì€ ì´ë¯¸ ì‹œì‘ë¨
                console.log('Symbol tracking system already started');
              } catch (error) {
                console.error('âŒ Error creating TradingView widget:', error);
              }
            } else {
              console.error('âŒ TradingView library not available');
            }
          };

          // ì¦‰ì‹œ ì´ˆê¸°í™” ì‹œë„
          console.log('ğŸš€ Starting TradingView initialization...');
          console.log('TradingView available:', typeof TradingView !== 'undefined');

          if (typeof TradingView !== 'undefined') {
            console.log('ğŸš€ TradingView library already loaded, initializing immediately...');
            window.initTradingView();
          } else {
            console.log('â³ TradingView library not loaded yet, waiting...');
            // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ëŒ€ê¸°
            let attempts = 0;
            const maxAttempts = 100; // 10ì´ˆ ëŒ€ê¸°

            const checkLibrary = setInterval(() => {
              attempts++;
              console.log(`â³ Checking TradingView library... attempt ${attempts}/${maxAttempts}`);

              if (typeof TradingView !== 'undefined') {
                clearInterval(checkLibrary);
                console.log('âœ… TradingView library loaded after', attempts, 'attempts');
                window.initTradingView();
              } else if (attempts >= maxAttempts) {
                clearInterval(checkLibrary);
                console.error('âŒ TradingView library loading timeout after', attempts, 'attempts');
              }
            }, 100);
          }

          // í‹°ì»¤ ì¶”ì¶œ í•¨ìˆ˜
          function extractTickerFromSymbol(symbolName) {
            if (!symbolName) return null;
            // 'NASDAQ:AAPL' -> 'AAPL'
            const parts = symbolName.split(':');
            return parts.length > 1 ? parts[1] : parts[0];
          }

          // ê¸€ë¡œë²Œ ì‹¬ë³¼ ë³€ê²½ ê°ì§€ ì‹œìŠ¤í…œ
          window.TradingViewSymbolTracker = {
            currentSymbol: 'NASDAQ:SPY',
            lastCheckedSymbol: '',
            isChecking: false,

            // ì‹¬ë³¼ ë³€ê²½ ì‹œ í˜¸ì¶œë  í•¨ìˆ˜
            onSymbolChange: function (newSymbol) {
              console.log('ğŸ¯ Symbol change detected:', this.currentSymbol, '->', newSymbol);
              this.currentSymbol = newSymbol;

              const ticker = extractTickerFromSymbol(newSymbol);
              if (ticker) {
                console.log('ğŸ¯ Triggering AI analysis for:', ticker);

                // ë…¸í‹°í”¼ì¼€ì´ì…˜
                if (window.NotificationManager) {
                  NotificationManager.show(`íŠ¸ë ˆì´ë”©ë·°ì—ì„œ ${ticker} ì„ íƒ - AI ë¶„ì„ ì‹œì‘`, 'success');
                }

                // AI ë¶„ì„ ì‹¤í–‰
                if (window.StockDetailAnalyzer) {
                  setTimeout(() => {
                    StockDetailAnalyzer.analyzeStock(ticker);
                  }, 1000);
                }
              }
            },

            // ìˆ˜ë™ìœ¼ë¡œ ì‹¬ë³¼ ì„¤ì •
            setSymbol: function (symbol) {
              if (symbol && symbol !== this.currentSymbol) {
                this.onSymbolChange(symbol);
              }
            },

            // ì£¼ê¸°ì  ì²´í¬ ì‹œì‘
            startChecking: function () {
              if (this.isChecking) return;
              this.isChecking = true;

              // postMessage ë¦¬ìŠ¤ë„ˆ ì„¤ì •
              this.setupPostMessageListener();

              // ì£¼ê¸°ì  ì²´í¬
              setInterval(() => {
                this.checkForSymbolChange();
              }, 2000); // 2ì´ˆë¡œ ë‹¨ì¶•
            },

            // postMessage ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setupPostMessageListener: function () {
              window.addEventListener('message', (event) => {
                if (event.origin === 'https://s.tradingview.com') {
                  try {
                    // JSON ë¬¸ìì—´ íŒŒì‹±
                    let messageData = event.data;
                    if (typeof messageData === 'string') {
                      messageData = JSON.parse(messageData);
                    }

                    // quoteUpdate ë©”ì‹œì§€ì—ì„œ ì‹¬ë³¼ ì¶”ì¶œ
                    if (messageData.name === 'quoteUpdate' && messageData.data) {
                      const data = messageData.data;
                      let symbol = null;

                      // ë‹¤ì–‘í•œ í•„ë“œì—ì„œ ì‹¬ë³¼ ì¶”ì¶œ
                      if (data.original_name) {
                        // "BATS_DLY:AMZN" -> "AMZN"
                        symbol = data.original_name.split(':').pop();
                      } else if (data.short_name) {
                        symbol = data.short_name;
                      } else if (data.symbol) {
                        symbol = data.symbol;
                      }

                      // ìœ íš¨í•œ ì£¼ì‹ ì‹¬ë³¼ì¸ì§€ í™•ì¸
                      if (symbol && typeof symbol === 'string' && /^[A-Z]{1,10}$/.test(symbol)) {
                        const fullSymbol = `NASDAQ:${symbol}`;

                        // í˜„ì¬ ì‹¬ë³¼ê³¼ ë‹¤ë¥¸ ê²½ìš°ë§Œ ì²˜ë¦¬
                        if (fullSymbol !== this.currentSymbol) {
                          console.log('ğŸ¯ QuoteUpdate symbol detected:', symbol, 'from', data.original_name || data.short_name);
                          this.setSymbol(fullSymbol);
                        }
                      }
                    }

                    // ê¸°íƒ€ ì‹¬ë³¼ ë³€ê²½ ì´ë²¤íŠ¸ ì²˜ë¦¬
                    else if (messageData.type === 'symbol-change' || messageData.action === 'symbol-change') {
                      const symbol = messageData.symbol || messageData.value;
                      if (symbol && /^[A-Z]{1,5}(:[A-Z]{1,10})?$/.test(symbol)) {
                        console.log('ğŸ¯ Symbol change event detected:', symbol);
                        const fullSymbol = symbol.includes(':') ? symbol : `NASDAQ:${symbol}`;
                        this.setSymbol(fullSymbol);
                      }
                    }

                  } catch (e) {
                    // JSON íŒŒì‹± ì˜¤ë¥˜ - ë¬´ì‹œ
                  }
                }
              });

              console.log('PostMessage listener set up');
            },

            checkForSymbolChange: function () {
              // 1. TradingView API ì‹œë„ (í˜¹ì‹œ ì‘ë™í•  ìˆ˜ ìˆìŒ)
              try {
                if (window.myTradingViewWidget &&
                  typeof window.myTradingViewWidget.chart === 'function') {
                  const apiSymbol = window.myTradingViewWidget.chart().symbol();
                  if (apiSymbol && apiSymbol !== this.currentSymbol) {
                    console.log('ğŸ¯ Found symbol via API:', apiSymbol);
                    this.onSymbolChange(apiSymbol);
                    return;
                  }
                }
              } catch (e) {
                // API ì‚¬ìš© ë¶ˆê°€
              }

              // 2. iframe ë‚´ë¶€ DOM ê°ì§€ (ì œí•œì ì´ì§€ë§Œ ì‹œë„)
              try {
                const iframe = document.querySelector('#tradingview_b4321 iframe');
                if (iframe && iframe.contentDocument) {
                  // iframe ë‚´ë¶€ì— ì ‘ê·¼ ê°€ëŠ¥í•œ ê²½ìš° (CORS ì œí•œìœ¼ë¡œ ë³´í†µ ë¶ˆê°€ëŠ¥)
                  const symbolElements = iframe.contentDocument.querySelectorAll('.tv-symbol-header, [data-symbol]');
                  for (let elem of symbolElements) {
                    const text = elem.textContent?.trim();
                    if (text && text !== this.currentSymbol) {
                      console.log('ğŸ¯ Found symbol in iframe DOM:', text);
                      this.setSymbol(text);
                      return;
                    }
                  }
                }
              } catch (e) {
                // CORS ì˜¤ë¥˜ - ì˜ˆìƒë¨
              }

              // 3. ë©”ì¸ í˜ì´ì§€ DOMì—ì„œ TradingView ê´€ë ¨ ìš”ì†Œ ì°¾ê¸°
              const selectors = [
                // TradingView ìœ„ì ¯ ê´€ë ¨
                '[data-widget-type="advanced-chart"] [data-symbol]',
                '.tradingview-widget-container [data-symbol]',
                '.tv-embed-widget-wrapper [data-symbol]',

                // ì¼ë°˜ì ì¸ ì‹¬ë³¼ í‘œì‹œ ìš”ì†Œ
                '.tv-symbol-header__short-name',
                '.tv-symbol-header__text',
                '.tv-header__symbol',
                '.symbol-name',
                '.js-symbol-name',
                '.tv-symbol-info__name',

                // ì°¨íŠ¸ ê´€ë ¨
                '.chart-container [data-name="legend-source-item"]',
                '.tv-widget-idea__symbol',

                // ë©”íƒ€ ì •ë³´
                'meta[property="og:title"]',
                'title'
              ];

              for (const selector of selectors) {
                try {
                  const elements = document.querySelectorAll(selector);
                  for (let elem of elements) {
                    let text = null;

                    if (elem.tagName === 'META') {
                      text = elem.getAttribute('content');
                    } else if (elem.tagName === 'TITLE') {
                      text = elem.textContent;
                    } else {
                      text = elem.textContent?.trim() || elem.dataset?.symbol || elem.getAttribute('data-symbol');
                    }

                    if (text && text.length >= 2) {
                      // ì‹¬ë³¼ íŒ¨í„´ ë§¤ì¹­
                      const symbolMatch = text.match(/([A-Z]{1,5}:)?([A-Z]{1,10})/);
                      if (symbolMatch) {
                        const symbol = symbolMatch[0];
                        const fullSymbol = symbol.includes(':') ? symbol : `NASDAQ:${symbol}`;

                        if (fullSymbol !== this.currentSymbol && fullSymbol.length > 5) {
                          console.log('ğŸ¯ Found symbol in DOM:', fullSymbol, 'from', selector);
                          this.onSymbolChange(fullSymbol);
                          return;
                        }
                      }
                    }
                  }
                } catch (e) {
                  // ë¬´ì‹œ
                }
              }
            }
          };

          // ì‹¬ë³¼ ê°ì§€ ì‹œì‘
          console.log('ğŸ¯ Starting TradingView Symbol Tracker...');
          window.TradingViewSymbolTracker.startChecking();

          // ì°¨íŠ¸ ë§¤ë‹ˆì €ì—ì„œë„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì „ì—­ í•¨ìˆ˜ ì œê³µ
          window.setTradingViewSymbol = function (symbol) {
            window.TradingViewSymbolTracker.setSymbol(symbol);
          };

          // DOMì´ ì´ë¯¸ ë¡œë“œë˜ì—ˆë‹¤ë‹ˆ ë°”ë¡œ ì´ˆê¸°í™”í•˜ê±°ë‚˜, ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œë¥¼ ê¸°ë‹¤ë¦¼
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function () {
              if (typeof TradingView !== 'undefined') {
                initTradingView();
              }
            });
          } else if (typeof TradingView !== 'undefined') {
            initTradingView();
          }
        </script>
      </div>
      <!-- TradingView Widget END -->
    </section>

    <!-- 2. AI ë¶„ì„ ê²°ê³¼ -->
    <section id="selected-stock-analysis">
      <h2>2. AI ë¶„ì„ ê²°ê³¼</h2>
      <p class="section-description">ì„ íƒëœ ì¢…ëª©ì˜ ìƒì„¸ AI ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
      <div id="selected-stock-header" class="stock-header">
        <p>ì¢…ëª©ì„ í´ë¦­í•˜ê±°ë‚˜ ìƒì„¸ ë¶„ì„ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì—¬ê¸°ì— ìƒì„¸ ë¶„ì„ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
      </div>
      <div id="selected-stock-fundamentals" class="stock-fundamentals">
        <!-- ê¸°ë³¸ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
      </div>
      <div id="selected-stock-details" class="analysis-result">
        <!-- ê¸°ìˆ ì  ë¶„ì„ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
      </div>
      <div id="selected-stock-description" class="stock-description">
        <!-- íšŒì‚¬ ì„¤ëª…ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
      </div>
    </section>

    <!-- 3. AI ì„¹í„° ì¢…ëª© -->
    <section id="ai-stocks">
      <h2>3. AI ì„¹í„° ì¢…ëª©</h2>
      <p class="section-description">ì£¼ìš” AI ê´€ë ¨ ê¸°ì—…ë“¤ì˜ ì‹¤ì‹œê°„ ë°ì´í„°ì™€ ê°„ë‹¨ ë¶„ì„</p>
      <div class="stock-list-grid">
        <!-- AI stocks will be loaded here -->
      </div>
    </section>

    <!-- 4. ë°˜ë„ì²´ ì„¹í„° ì¢…ëª© -->
    <section id="semiconductor-stocks">
      <h2>4. ë°˜ë„ì²´ ì„¹í„° ì¢…ëª©</h2>
      <p class="section-description">ë°˜ë„ì²´ ì‚°ì—… ì£¼ìš” ê¸°ì—…ë“¤ì˜ ì‹¤ì‹œê°„ ë°ì´í„°ì™€ ê°„ë‹¨ ë¶„ì„</p>
      <div class="stock-list-grid">
        <!-- Semiconductor stocks will be loaded here -->
      </div>
    </section>

    <!-- 5. AI ì¢…ëª© ì¶”ì²œ -->
    <section id="monthly-recommendations">
      <div class="recommendation-header">
        <h2>5. ì´ë²ˆë‹¬ AI ì¢…ëª© ì¶”ì²œ</h2>

        <div class="recommendation-controls">
          <button id="refresh-recommendations" class="btn-refresh">ìƒˆë¡œê³ ì¹¨</button>
          <select id="sector-filter">
            <option value="all">ì „ì²´</option>
            <option value="ai">AI</option>
            <option value="semiconductor">ë°˜ë„ì²´</option>
          </select>
        </div>
      </div>
      <div id="recommendations-content">
        <div class="loading-spinner">
          <p>ì›”ë³„ ì¶”ì²œ ì¢…ëª©ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
      </div>
    </section>
  </main>
  <!-- Load scripts in dependency order -->
  <script src="js/config.js"></script>
  <script src="js/notification-manager.js"></script>
  <script src="js/tooltip-manager.js"></script>
  <script src="js/chart-manager.js"></script>
  <script src="js/stock-analyzer.js"></script>
  <script src="js/stock-selector.js"></script>
  <script src="js/seasonal-analysis.js"></script>
  <script src="js/recommendation-ui.js"></script>
  <script src="js/stock-detail-analyzer.js"></script>
  <script src="js/monthly-recommendation-manager.js"></script>
  <script src="client.js"></script>
</body>

</html>